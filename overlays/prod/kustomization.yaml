apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

namespace: default

resources:
  - ../../base/identity-service
  - ../../base/user-service
  - ../../base/blog-service
  - ../../base/frontend
  - ../../base/media-api
  - ../../base/image-worker
  - ../../base/video-worker
  - ../../base/audio-worker
  - ../../base/document-worker
  - ../../base/archive-worker
  - ../../base/upload-service

# Production patches (HA replicas + resource limits)
patches:
  - path: patches/replicas-ha.yaml     # HA replica counts
  - path: patches/resources-prod.yaml  # Production resource requests/limits

# ─── Image Tag Management via configMapGenerator ───────────────────────────
# CI/CD updates the literals below (one per service). configMapGenerator hashes
# the content, so any tag change produces a new ConfigMap name → ArgoCD detects
# the diff and syncs. The `replacements` block injects each literal value into
# the corresponding CRD's spec.image field at kustomize-build time.
#
# To update a service image tag:
#   sed -i "s|identity-service=939217651725.dkr.ecr.eu-west-2.amazonaws.com/kubeadm_ec2_cluster/identity-service:v19-eb6df79
#
configMapGenerator:
  - name: platform-rules
    files:
      - rules.json
    options:
      disableNameSuffixHash: true
  - name: service-images
    literals:
      - identity-service=939217651725.dkr.ecr.eu-west-2.amazonaws.com/kubeadm_ec2_cluster/identity-service:v19-eb6df79
      - user-service=939217651725.dkr.ecr.eu-west-2.amazonaws.com/kubeadm_ec2_cluster/user-service:v19-eb6df79
      - blog-service=939217651725.dkr.ecr.eu-west-2.amazonaws.com/kubeadm_ec2_cluster/blog-service:v19-eb6df79
      - frontend=939217651725.dkr.ecr.eu-west-2.amazonaws.com/kubeadm_ec2_cluster/frontend:v19-eb6df79
      - media-api=939217651725.dkr.ecr.eu-west-2.amazonaws.com/kubeadm_ec2_cluster/media-api:v17-1ab807f
      - image-worker=939217651725.dkr.ecr.eu-west-2.amazonaws.com/kubeadm_ec2_cluster/image-worker:v19-eb6df79
      - video-worker=939217651725.dkr.ecr.eu-west-2.amazonaws.com/kubeadm_ec2_cluster/video-worker:v19-eb6df79
      - audio-worker=939217651725.dkr.ecr.eu-west-2.amazonaws.com/kubeadm_ec2_cluster/audio-worker:v19-eb6df79
      - document-worker=939217651725.dkr.ecr.eu-west-2.amazonaws.com/kubeadm_ec2_cluster/document-worker:v19-eb6df79
      - archive-worker=939217651725.dkr.ecr.eu-west-2.amazonaws.com/kubeadm_ec2_cluster/archive-worker:v19-eb6df79
      - upload-service=939217651725.dkr.ecr.eu-west-2.amazonaws.com/kubeadm_ec2_cluster/upload-service:v7-77ebed8

# ─── Replacements: ConfigMap literals → CRD spec.image ─────────────────────
# Each replacement sources a value from the service-images ConfigMap and injects
# it into the target CRD's spec.image field. This replaces the old
# images-prod.yaml strategic merge patch approach.
replacements:
  - source:
      kind: ConfigMap
      name: service-images
      fieldPath: data.identity-service
    targets:
      - select:
          kind: IdentityService
          name: identity-service
        fieldPaths:
          - spec.image
  - source:
      kind: ConfigMap
      name: service-images
      fieldPath: data.user-service
    targets:
      - select:
          kind: UserService
          name: user-service
        fieldPaths:
          - spec.image
  - source:
      kind: ConfigMap
      name: service-images
      fieldPath: data.blog-service
    targets:
      - select:
          kind: BlogService
          name: blog-service
        fieldPaths:
          - spec.image
  - source:
      kind: ConfigMap
      name: service-images
      fieldPath: data.frontend
    targets:
      - select:
          kind: Frontend
          name: auth-frontend
        fieldPaths:
          - spec.image
  - source:
      kind: ConfigMap
      name: service-images
      fieldPath: data.media-api
    targets:
      - select:
          kind: MediaApiService
          name: media-api
        fieldPaths:
          - spec.image
  - source:
      kind: ConfigMap
      name: service-images
      fieldPath: data.image-worker
    targets:
      - select:
          kind: ImageWorker
          name: image-worker
        fieldPaths:
          - spec.image
  - source:
      kind: ConfigMap
      name: service-images
      fieldPath: data.video-worker
    targets:
      - select:
          kind: VideoWorker
          name: video-worker
        fieldPaths:
          - spec.image
  - source:
      kind: ConfigMap
      name: service-images
      fieldPath: data.audio-worker
    targets:
      - select:
          kind: AudioWorker
          name: audio-worker
        fieldPaths:
          - spec.image
  - source:
      kind: ConfigMap
      name: service-images
      fieldPath: data.document-worker
    targets:
      - select:
          kind: DocumentWorker
          name: document-worker
        fieldPaths:
          - spec.image
  - source:
      kind: ConfigMap
      name: service-images
      fieldPath: data.archive-worker
    targets:
      - select:
          kind: ArchiveWorker
          name: archive-worker
        fieldPaths:
          - spec.image
  - source:
      kind: ConfigMap
      name: service-images
      fieldPath: data.upload-service
    targets:
      - select:
          kind: UploadService
          name: upload-service
        fieldPaths:
          - spec.image

labels:
  - pairs:
      environment: prod
    includeSelectors: false
