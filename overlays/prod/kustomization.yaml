apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

namespace: default

resources:
  - ../../base/identity-service
  - ../../base/auth-service
  - ../../base/user-service
  - ../../base/blog-service
  - ../../base/frontend

# NOTE: Kustomize `images` transformer does NOT work on CRD custom fields
# (spec.image). We use strategic merge patches instead — see patches/images-prod.yaml
# CI/CD update-gitops job uses yq to update the patch file after each build.

# Production patches
patches:
  - path: patches/images-prod.yaml     # Override spec.image → ECR tags (updated by CI/CD)
  - path: patches/replicas-ha.yaml     # HA replica counts
  - path: patches/resources-prod.yaml  # Production resource requests/limits

# ConfigMap for production rules
configMapGenerator:
  - name: platform-rules
    files:
      - rules.json
    options:
      disableNameSuffixHash: true

labels:
  - pairs:
      environment: prod
    includeSelectors: false
