# Build and push service images to ECR
# This is a reusable workflow called by service-specific workflows

name: Build and Push to ECR

on:
  workflow_call:
    inputs:
      service_name:
        required: true
        type: string
        description: "Name of the service (e.g., identity-service)"
      dockerfile_path:
        required: false
        type: string
        default: "Dockerfile"
        description: "Path to Dockerfile relative to context"
      context_path:
        required: true
        type: string
        description: "Build context path"
      environment:
        required: false
        type: string
        default: "prod"
        description: "Target environment"
    outputs:
      image_tag:
        description: "The image tag that was pushed"
        value: ${{ jobs.build.outputs.image_tag }}
      image_uri:
        description: "Full image URI"
        value: ${{ jobs.build.outputs.image_uri }}

env:
  AWS_REGION: eu-west-2
  # These come from Pulumi outputs - set as repository variables
  AWS_ROLE_ARN: ${{ vars.AWS_ROLE_ARN }}
  ECR_REGISTRY: ${{ vars.ECR_REGISTRY }}
  CLUSTER_NAME: ${{ vars.CLUSTER_NAME }}

# Required for OIDC
permissions:
  id-token: write
  contents: read

jobs:
  build:
    runs-on: ubuntu-latest
    outputs:
      image_tag: ${{ steps.meta.outputs.version }}
      image_uri: ${{ steps.build.outputs.image_uri }}
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials via OIDC
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ env.AWS_ROLE_ARN }}
          role-session-name: github-actions-${{ github.run_id }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Extract metadata
        id: meta
        run: |
          # Generate version tag
          SHA_SHORT=$(echo ${{ github.sha }} | cut -c1-7)
          
          if [[ "${{ github.ref }}" == "refs/tags/"* ]]; then
            # Use tag version
            VERSION=${GITHUB_REF#refs/tags/}
          else
            # Use run number with sha
            VERSION="v${{ github.run_number }}-${SHA_SHORT}"
          fi
          
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "sha_short=${SHA_SHORT}" >> $GITHUB_OUTPUT
          echo "Generated version: ${VERSION}"

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and push
        id: build
        uses: docker/build-push-action@v5
        with:
          context: ${{ inputs.context_path }}
          file: ${{ inputs.context_path }}/${{ inputs.dockerfile_path }}
          push: true
          tags: |
            ${{ steps.login-ecr.outputs.registry }}/${{ env.CLUSTER_NAME }}/${{ inputs.service_name }}:${{ steps.meta.outputs.version }}
            ${{ steps.login-ecr.outputs.registry }}/${{ env.CLUSTER_NAME }}/${{ inputs.service_name }}:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            BUILD_VERSION=${{ steps.meta.outputs.version }}
            BUILD_SHA=${{ github.sha }}

      - name: Output image URI
        run: |
          IMAGE_URI="${{ steps.login-ecr.outputs.registry }}/${{ env.CLUSTER_NAME }}/${{ inputs.service_name }}:${{ steps.meta.outputs.version }}"
          echo "image_uri=${IMAGE_URI}" >> $GITHUB_OUTPUT
          echo "âœ… Pushed: ${IMAGE_URI}"

      - name: Scan image for vulnerabilities
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ steps.login-ecr.outputs.registry }}/${{ env.CLUSTER_NAME }}/${{ inputs.service_name }}:${{ steps.meta.outputs.version }}
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH'
        continue-on-error: true

      - name: Upload Trivy scan results
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: 'trivy-results.sarif'
        continue-on-error: true
