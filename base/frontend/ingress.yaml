---
# Frontend catch-all ingress (no rewrite needed)
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: frontend-ingress
  namespace: default
  annotations:
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    nginx.ingress.kubernetes.io/proxy-body-size: "10m"
    # TLS secret is reflected from cert-manager/platform-wildcard-certificate
    # by emberstack reflector — no separate cert-manager issuer needed.
    # This prevents Let's Encrypt rate limiting on teardown/rebuild cycles.
spec:
  ingressClassName: nginx
  tls:
  - hosts:
    - healthxcape.com
    - www.healthxcape.com
    secretName: platform-wildcard-certificate
  rules:
  - host: healthxcape.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: auth-frontend
            port:
              number: 3000
  - host: www.healthxcape.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: auth-frontend
            port:
              number: 3000
---
# API gateway ingress — routes /api/<service>/(...) to backend services
# rewrite-target strips the /api/<service> prefix before forwarding
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: api-gateway-ingress
  namespace: default
  annotations:
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    nginx.ingress.kubernetes.io/use-regex: "true"
    nginx.ingress.kubernetes.io/rewrite-target: /$1
    # TLS secret reflected from cert-manager/platform-wildcard-certificate
spec:
  ingressClassName: nginx
  tls:
  - hosts:
    - healthxcape.com
    - www.healthxcape.com
    secretName: platform-wildcard-certificate
  rules:
  - host: healthxcape.com
    http:
      paths:
      - path: /api/(identity(?:/.*)?)
        pathType: ImplementationSpecific
        backend:
          service:
            name: identity-service
            port:
              number: 3000
      - path: /api/user/(.*)
        pathType: ImplementationSpecific
        backend:
          service:
            name: user-service
            port:
              number: 3001
      - path: /api/blog/(.*)
        pathType: ImplementationSpecific
        backend:
          service:
            name: blog-service
            port:
              number: 3002
  - host: www.healthxcape.com
    http:
      paths:
      - path: /api/(identity(?:/.*)?)
        pathType: ImplementationSpecific
        backend:
          service:
            name: identity-service
            port:
              number: 3000
      - path: /api/user/(.*)
        pathType: ImplementationSpecific
        backend:
          service:
            name: user-service
            port:
              number: 3001
      - path: /api/blog/(.*)
        pathType: ImplementationSpecific
        backend:
          service:
            name: blog-service
            port:
              number: 3002
